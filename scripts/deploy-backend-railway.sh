#!/bin/bash

# ğŸš‚ DEPLOY BACKEND NO RAILWAY
# Deploy do servidor Express separadamente

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš‚ RAILWAY BACKEND DEPLOY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# [1/5] Verificar Railway CLI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/5] Verificando Railway CLI..."

if ! command -v railway &> /dev/null; then
    echo "ğŸ“¦ Instalando Railway CLI..."
    npm install -g @railway/cli
    echo "âœ… Railway CLI instalado"
else
    echo "âœ… Railway CLI jÃ¡ instalado"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# [2/5] Login
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/5] Verificando autenticaÃ§Ã£o..."

if ! railway whoami &> /dev/null; then
    echo "ğŸ” Fazendo login no Railway..."
    railway login
    echo "âœ… Login concluÃ­do"
else
    echo "âœ… JÃ¡ autenticado: $(railway whoami)"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# [3/5] Criar/Selecionar projeto
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/5] Configurando projeto..."

if [ ! -f ".railway" ]; then
    echo "ğŸ“ Criando novo projeto Railway..."
    railway init
else
    echo "âœ… Projeto Railway jÃ¡ configurado"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# [4/5] Configurar variÃ¡veis de ambiente
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/5] Configurando variÃ¡veis de ambiente..."

echo "Configurar variÃ¡veis? [y/N]: "
read -p "" CONFIGURE_ENV

if [ "$CONFIGURE_ENV" = "y" ] || [ "$CONFIGURE_ENV" = "Y" ]; then
    echo ""
    echo "Adicione as seguintes variÃ¡veis no Railway Dashboard:"
    echo "https://railway.app/dashboard"
    echo ""
    echo "VITE_SUPABASE_URL=https://pwtjuuhchtbzttrzoutw.supabase.co"
    echo "VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    echo "NODE_ENV=production"
    echo "PORT=5000"
    echo ""
    echo "Pressione Enter quando terminar..."
    read
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# [5/5] Deploy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[5/5] Fazendo deploy..."
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

railway up

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… DEPLOY CONCLUÃDO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Obter URL do deploy
BACKEND_URL=$(railway domain 2>/dev/null || echo "")

if [ -n "$BACKEND_URL" ]; then
    echo -e "${GREEN}ğŸŒ Backend URL:${NC} https://$BACKEND_URL"
    echo ""
    echo "ğŸ“‹ PrÃ³ximos passos:"
    echo ""
    echo "1. Testar backend:"
    echo "   curl https://$BACKEND_URL/api/health"
    echo ""
    echo "2. Atualizar vercel.json:"
    echo "   Alterar 'destination' de /api/* para:"
    echo "   https://$BACKEND_URL/api/:path*"
    echo ""
    echo "3. Deploy frontend na Vercel:"
    echo "   vercel --prod"
    echo ""
else
    echo "âš ï¸  URL do backend nÃ£o obtida automaticamente"
    echo ""
    echo "ğŸ“‹ PrÃ³ximos passos:"
    echo ""
    echo "1. Obter URL no Railway Dashboard:"
    echo "   https://railway.app/dashboard"
    echo ""
    echo "2. Testar backend:"
    echo "   curl https://seu-projeto.railway.app/api/health"
    echo ""
    echo "3. Atualizar vercel.json:"
    echo "   Alterar 'destination' de /api/* para sua URL"
    echo ""
    echo "4. Deploy frontend:"
    echo "   vercel --prod"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
