#!/bin/bash

# ============================================================================
# Script para Aplicar Migration 20251028_optimize_component_queries.sql
# ============================================================================
# 
# ESTE SCRIPT DOCUMENTA COMO APLICAR A MIGRATION NO SUPABASE
# 
# âš ï¸ IMPORTANTE: Migrations DDL (CREATE INDEX, CREATE FUNCTION) devem ser
#    aplicadas via Supabase Dashboard ou CLI, nÃ£o via client SDK.
#
# ============================================================================

set -e

echo "ğŸš€ GUIA DE APLICAÃ‡ÃƒO DA MIGRATION - Fase 4.2"
echo ""
echo "ğŸ“‹ Migration: 20251028_optimize_component_queries.sql"
echo "ğŸ“‚ LocalizaÃ§Ã£o: supabase/migrations/20251028_optimize_component_queries.sql"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "OPÃ‡ÃƒO 1: Supabase Dashboard (RECOMENDADO)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. Acesse: https://supabase.com/dashboard/project/your-supabase-project-ref"
echo "2. Navegue para: SQL Editor"
echo "3. Clique em: New Query"
echo "4. Cole o conteÃºdo do arquivo:"
echo "   supabase/migrations/20251028_optimize_component_queries.sql"
echo "5. Execute: RUN"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "OPÃ‡ÃƒO 2: Supabase CLI (se disponÃ­vel)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Se vocÃª tiver o Supabase CLI instalado:"
echo ""
echo "  cd supabase"
echo "  supabase db push --linked"
echo ""
echo "ou"
echo ""
echo "  npx supabase db push --linked"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "OPÃ‡ÃƒO 3: Script Node.js (em desenvolvimento)"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "  npm run db:migrate"
echo ""
echo "  (Nota: Este comando ainda nÃ£o estÃ¡ implementado)"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“Š O QUE SERÃ CRIADO:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ… 4 Ãndices de Performance:"
echo "   - idx_components_funnel_step (funnel_id, step_number, order_index)"
echo "   - idx_components_type (component_type_key)"
echo "   - idx_components_stage (stage_id, order_index)"
echo "   - idx_components_active (is_active, funnel_id, step_number)"
echo ""
echo "âœ… 2 RPC Functions:"
echo "   - batch_update_components(updates jsonb)"
echo "   - batch_reorder_components(component_ids uuid[], new_positions integer[])"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“ˆ BENEFÃCIOS ESPERADOS:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš¡ ~70% melhoria em operaÃ§Ãµes de batch update"
echo "âš¡ ~50% melhoria em queries por funnel/step"
echo "âš¡ TransaÃ§Ãµes atÃ´micas garantidas para batch operations"
echo "âš¡ Melhor performance em reordenaÃ§Ã£o de componentes"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ” VERIFICAÃ‡ÃƒO PÃ“S-APLICAÃ‡ÃƒO:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Execute no SQL Editor para verificar:"
echo ""
echo "-- Verificar Ã­ndices criados"
echo "SELECT indexname FROM pg_indexes"
echo "WHERE tablename = 'component_instances'"
echo "  AND indexname LIKE 'idx_components_%';"
echo ""
echo "-- Verificar RPC functions criadas"
echo "SELECT routine_name FROM information_schema.routines"
echo "WHERE routine_schema = 'public'"
echo "  AND routine_name LIKE 'batch_%';"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRÃ“XIMOS PASSOS (apÃ³s aplicar migration):"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. Regenerar types TypeScript:"
echo "   npx supabase gen types typescript --linked > src/integrations/supabase/types.ts"
echo ""
echo "2. Ativar RPC no cÃ³digo:"
echo "   - Descomentar chamada RPC em funnelComponentsService.ts"
echo "   - Remover fallback Promise.all"
echo ""
echo "3. Testar em ambiente de desenvolvimento"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Verificar se o arquivo de migration existe
if [ ! -f "supabase/migrations/20251028_optimize_component_queries.sql" ]; then
    echo ""
    echo "âŒ ERRO: Arquivo de migration nÃ£o encontrado!"
    echo "   Esperado: supabase/migrations/20251028_optimize_component_queries.sql"
    exit 1
fi

echo ""
echo "âœ… Arquivo de migration encontrado e pronto para aplicaÃ§Ã£o!"
echo ""
echo "ğŸ“ Para visualizar o conteÃºdo da migration:"
echo "   cat supabase/migrations/20251028_optimize_component_queries.sql"
echo ""
