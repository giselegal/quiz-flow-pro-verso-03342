<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Isolamento entre Funnels</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 12px;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #00ff88;
            color: #000;
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { 
            background: #00cc6a;
            transform: translateY(-2px);
            transition: all 0.2s;
        }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            font-family: monospace;
        }
        .pass { color: #00ff88; }
        .fail { color: #ff6b6b; }
        .warning { color: #ffd93d; }
        h1, h2 { text-align: center; }
        h1 { color: #00ff88; text-shadow: 0 0 10px rgba(0,255,136,0.3); }
        iframe { 
            width: 100%; 
            height: 300px; 
            border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 8px;
            margin: 10px 0;
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Teste de Isolamento entre Funnels</h1>
        
        <div class="test-section">
            <h2>üìã Objetivo do Teste</h2>
            <p>Verificar se cada funnel mant√©m seus dados isolados, sem interferir em outros funnels ou templates.</p>
        </div>

        <div class="test-section">
            <h2>üß™ Testes de Isolamento</h2>
            
            <button onclick="testLocalStorageIsolation()">Testar Isolamento do LocalStorage</button>
            <button onclick="testBlockInstantiation()">Testar Instancia√ß√£o de Blocos</button>
            <button onclick="testFunnelContexts()">Testar Contextos de Funnel</button>
            <button onclick="clearAllData()">Limpar Todos os Dados</button>
            
            <div id="testResults" class="result"></div>
        </div>

        <div class="test-section">
            <h2>üîÄ Teste Pr√°tico com 2 Funnels</h2>
            <p>Abra dois funnels diferentes e verifique se as mudan√ßas em um n√£o afetam o outro:</p>
            
            <div class="grid">
                <div>
                    <h3>Funnel A (Template Quiz)</h3>
                    <button onclick="openFunnel('quiz-template')">Abrir Quiz Template</button>
                    <iframe id="funnelA" src="about:blank"></iframe>
                </div>
                
                <div>
                    <h3>Funnel B (Template Lead Magnet)</h3>
                    <button onclick="openFunnel('lead-magnet')">Abrir Lead Magnet</button>
                    <iframe id="funnelB" src="about:blank"></iframe>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Status dos Dados por Funnel</h2>
            <button onclick="showAllFunnelData()">Mostrar Dados de Todos os Funnels</button>
            <div id="funnelDataStatus" class="result"></div>
        </div>
    </div>

    <script>
        // Simula funnelStorageKeys.ts
        const funnelStorageKeys = {
            session: (funnelId) => `funnel_${funnelId}_session`,
            step: (funnelId, stepId) => `funnel_${funnelId}_step_${stepId}`,
            formValue: (funnelId, blockId) => `funnel_${funnelId}_form_${blockId}`,
            editorState: (funnelId) => `funnel_${funnelId}_editor_state`,
            autoSave: (funnelId) => `funnel_${funnelId}_auto_save`,
            blocks: (funnelId) => `funnel_${funnelId}_blocks`,
            responses: (funnelId) => `funnel_${funnelId}_responses`
        };

        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'warning';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function testLocalStorageIsolation() {
            log('üß™ Iniciando teste de isolamento do localStorage...', 'info');
            
            const testFunnels = ['funnel-1', 'funnel-2', 'funnel-3'];
            let passed = 0;
            let total = 0;
            
            // Limpar dados anteriores
            testFunnels.forEach(funnelId => {
                Object.values(funnelStorageKeys).forEach(keyFn => {
                    if (typeof keyFn === 'function') {
                        try {
                            localStorage.removeItem(keyFn(funnelId));
                            localStorage.removeItem(keyFn(funnelId, 'test-block'));
                        } catch (e) {}
                    }
                });
            });
            
            // Teste 1: Verificar chaves √∫nicas por funnel
            testFunnels.forEach(funnelId => {
                const sessionKey = funnelStorageKeys.session(funnelId);
                const editorKey = funnelStorageKeys.editorState(funnelId);
                
                localStorage.setItem(sessionKey, JSON.stringify({ funnelId, data: `session-${funnelId}` }));
                localStorage.setItem(editorKey, JSON.stringify({ funnelId, data: `editor-${funnelId}` }));
                
                total++;
                if (localStorage.getItem(sessionKey)) {
                    passed++;
                    log(`‚úÖ Funnel ${funnelId}: chave de sess√£o criada corretamente`, 'pass');
                } else {
                    log(`‚ùå Funnel ${funnelId}: falha ao criar chave de sess√£o`, 'fail');
                }
            });
            
            // Teste 2: Verificar isolamento entre funnels
            testFunnels.forEach((funnelId, index) => {
                const otherFunnels = testFunnels.filter((_, i) => i !== index);
                
                otherFunnels.forEach(otherFunnelId => {
                    const myKey = funnelStorageKeys.session(funnelId);
                    const otherKey = funnelStorageKeys.session(otherFunnelId);
                    
                    total++;
                    if (myKey !== otherKey) {
                        passed++;
                        log(`‚úÖ Chaves isoladas: ${funnelId} ‚â† ${otherFunnelId}`, 'pass');
                    } else {
                        log(`‚ùå Chaves conflitando: ${funnelId} = ${otherFunnelId}`, 'fail');
                    }
                });
            });
            
            log(`üìä Resultado: ${passed}/${total} testes passaram (${Math.round(passed/total*100)}%)`, passed === total ? 'pass' : 'fail');
        }

        function testBlockInstantiation() {
            log('üß© Testando instancia√ß√£o de blocos...', 'info');
            
            const templateBlocks = [
                { id: 'block-1', type: 'heading', text: 'Template Heading' },
                { id: 'block-2', type: 'form', fields: ['name', 'email'] }
            ];
            
            const funnelIds = ['funnel-a', 'funnel-b'];
            let passed = 0;
            let total = 0;
            
            // Simula clonagem de blocos com IDs √∫nicos
            funnelIds.forEach(funnelId => {
                const clonedBlocks = templateBlocks.map(block => ({
                    ...block,
                    id: `${funnelId}_${block.id}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                }));
                
                localStorage.setItem(funnelStorageKeys.blocks(funnelId), JSON.stringify(clonedBlocks));
                
                total++;
                if (clonedBlocks.every(block => block.id.includes(funnelId))) {
                    passed++;
                    log(`‚úÖ Blocos do ${funnelId} t√™m IDs √∫nicos`, 'pass');
                } else {
                    log(`‚ùå Blocos do ${funnelId} n√£o t√™m IDs √∫nicos`, 'fail');
                }
            });
            
            // Verificar se os IDs s√£o diferentes entre funnels
            const blocksA = JSON.parse(localStorage.getItem(funnelStorageKeys.blocks('funnel-a')) || '[]');
            const blocksB = JSON.parse(localStorage.getItem(funnelStorageKeys.blocks('funnel-b')) || '[]');
            
            const idsA = blocksA.map(b => b.id);
            const idsB = blocksB.map(b => b.id);
            const hasCommonIds = idsA.some(id => idsB.includes(id));
            
            total++;
            if (!hasCommonIds) {
                passed++;
                log(`‚úÖ Nenhum ID de bloco compartilhado entre funnels`, 'pass');
            } else {
                log(`‚ùå IDs de blocos compartilhados detectados`, 'fail');
            }
            
            log(`üìä Resultado: ${passed}/${total} testes passaram (${Math.round(passed/total*100)}%)`, passed === total ? 'pass' : 'fail');
        }

        function testFunnelContexts() {
            log('üìù Testando contextos de funnel...', 'info');
            
            const testScenarios = [
                { funnelId: 'quiz-001', stepId: 'step-1', response: 'Resposta A' },
                { funnelId: 'quiz-002', stepId: 'step-1', response: 'Resposta B' },
                { funnelId: 'lead-001', stepId: 'step-1', response: 'Resposta C' }
            ];
            
            let passed = 0;
            let total = 0;
            
            // Simula salvamento de respostas por funnel
            testScenarios.forEach(scenario => {
                const responseKey = funnelStorageKeys.responses(scenario.funnelId);
                const responses = JSON.parse(localStorage.getItem(responseKey) || '{}');
                responses[scenario.stepId] = scenario.response;
                localStorage.setItem(responseKey, JSON.stringify(responses));
                
                total++;
                const saved = JSON.parse(localStorage.getItem(responseKey) || '{}');
                if (saved[scenario.stepId] === scenario.response) {
                    passed++;
                    log(`‚úÖ Resposta salva para ${scenario.funnelId}`, 'pass');
                } else {
                    log(`‚ùå Falha ao salvar resposta para ${scenario.funnelId}`, 'fail');
                }
            });
            
            // Verificar isolamento de respostas
            testScenarios.forEach((scenario, index) => {
                const otherScenarios = testScenarios.filter((_, i) => i !== index);
                
                otherScenarios.forEach(otherScenario => {
                    total++;
                    const myResponses = JSON.parse(localStorage.getItem(funnelStorageKeys.responses(scenario.funnelId)) || '{}');
                    const otherResponses = JSON.parse(localStorage.getItem(funnelStorageKeys.responses(otherScenario.funnelId)) || '{}');
                    
                    if (JSON.stringify(myResponses) !== JSON.stringify(otherResponses)) {
                        passed++;
                        log(`‚úÖ Respostas isoladas: ${scenario.funnelId} ‚â† ${otherScenario.funnelId}`, 'pass');
                    } else {
                        log(`‚ùå Respostas compartilhadas: ${scenario.funnelId} = ${otherScenario.funnelId}`, 'fail');
                    }
                });
            });
            
            log(`üìä Resultado: ${passed}/${total} testes passaram (${Math.round(passed/total*100)}%)`, passed === total ? 'pass' : 'fail');
        }

        function openFunnel(templateType) {
            const baseUrl = window.location.origin;
            const funnelId = `${templateType}-${Date.now()}`;
            const url = `${baseUrl}/?funnel=${funnelId}`;
            
            if (templateType === 'quiz-template') {
                document.getElementById('funnelA').src = url;
                log(`üîó Funnel A aberto: ${funnelId}`, 'info');
            } else {
                document.getElementById('funnelB').src = url;
                log(`üîó Funnel B aberto: ${funnelId}`, 'info');
            }
        }

        function showAllFunnelData() {
            log('üìä Mapeando todos os dados de funnels...', 'info');
            
            const funnelData = {};
            const statusDiv = document.getElementById('funnelDataStatus');
            statusDiv.innerHTML = '';
            
            // Scanear localStorage para dados de funnels
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('funnel_')) {
                    const parts = key.split('_');
                    if (parts.length >= 2) {
                        const funnelId = parts[1];
                        if (!funnelData[funnelId]) {
                            funnelData[funnelId] = {};
                        }
                        try {
                            funnelData[funnelId][key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            funnelData[funnelId][key] = localStorage.getItem(key);
                        }
                    }
                }
            }
            
            const funnelCount = Object.keys(funnelData).length;
            if (funnelCount === 0) {
                statusDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Nenhum dado de funnel encontrado no localStorage</div>';
                return;
            }
            
            statusDiv.innerHTML = `<div class="pass">‚úÖ ${funnelCount} funnel(s) encontrado(s)</div>`;
            
            Object.entries(funnelData).forEach(([funnelId, data]) => {
                const keyCount = Object.keys(data).length;
                statusDiv.innerHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                        <strong>Funnel: ${funnelId}</strong> (${keyCount} chaves)
                        <details style="margin-top: 5px;">
                            <summary style="cursor: pointer;">Ver dados</summary>
                            <pre style="font-size: 12px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    </div>
                `;
            });
            
            log(`üìã ${funnelCount} funnel(s) mapeado(s) com sucesso`, 'pass');
        }

        function clearAllData() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('funnel_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('funnelDataStatus').innerHTML = '';
            
            log(`üßπ ${keysToRemove.length} chaves de funnel removidas`, 'warning');
        }

        // Auto-executar alguns testes iniciais
        window.addEventListener('load', () => {
            log('üöÄ Sistema de testes carregado', 'pass');
            log('üí° Clique nos bot√µes para executar os testes de isolamento', 'info');
        });
    </script>
</body>
</html>
