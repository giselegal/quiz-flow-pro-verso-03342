/**
 * üîó EDITOR DATA SERVICE - Conecta JSON Templates com Painel de Propriedades
 * 
 * Este servi√ßo gerencia a conex√£o bi-direcional entre:
 * - Templates JSON reais das 21 etapas
 * - Estado do HeadlessEditorProvider
 * - Painel de propriedades
 * - Persist√™ncia (localStorage, Supabase)
 */

import { QuizFunnelSchema, FunnelStep } from '../../../types/quiz-schema';
import { Block } from '../../../types/editor';
import { TemplateJsonLoader } from '../../../utils/TemplateJsonLoader';

export interface EditorDataServiceConfig {
    autoSave: boolean;
    autoSaveInterval: number;
    enableCache: boolean;
    enableValidation: boolean;
}

export interface SchemaChangeEvent {
    type: 'step' | 'global' | 'style' | 'publish';
    stepId?: string;
    changes: any;
    timestamp: number;
}

export interface PersistenceResult {
    success: boolean;
    location: 'localStorage' | 'supabase' | 'file';
    timestamp: number;
    error?: string;
}

export class EditorDataService {
    private static instance: EditorDataService;
    private config: EditorDataServiceConfig;
    private currentSchema: QuizFunnelSchema | null = null;
    private changeListeners: Set<(event: SchemaChangeEvent) => void> = new Set();
    private autoSaveTimer: NodeJS.Timeout | null = null;
    private isDirty = false;

    private constructor(config: EditorDataServiceConfig) {
        this.config = config;
    }

    static getInstance(config?: EditorDataServiceConfig): EditorDataService {
        if (!EditorDataService.instance) {
            EditorDataService.instance = new EditorDataService(
                config || {
                    autoSave: true,
                    autoSaveInterval: 30000, // 30 segundos
                    enableCache: true,
                    enableValidation: true,
                }
            );
        }
        return EditorDataService.instance;
    }

    // ============================================================================
    // CARREGAMENTO DE DADOS JSON
    // ============================================================================

    /**
     * Carrega schema completo de uma fonte JSON
     */
    async loadSchemaFromJson(
        sourceType: 'template' | 'saved' | 'published',
        identifier: string
    ): Promise<QuizFunnelSchema> {
        try {
            let schema: QuizFunnelSchema;

            switch (sourceType) {
                case 'template':
                    schema = await this.loadFromTemplate(identifier);
                    break;
                case 'saved':
                    schema = await this.loadFromLocalStorage(identifier);
                    break;
                case 'published':
                    schema = await this.loadFromSupabase(identifier);
                    break;
                default:
                    throw new Error(`Tipo de fonte n√£o suportado: ${sourceType}`);
            }

            // Validar schema se habilitado
            if (this.config.enableValidation) {
                this.validateSchema(schema);
            }

            this.currentSchema = schema;
            this.isDirty = false;

            console.log(`‚úÖ Schema carregado de ${sourceType}:`, schema);
            return schema;

        } catch (error) {
            console.error(`‚ùå Erro ao carregar schema de ${sourceType}:`, error);
            throw error;
        }
    }

    /**
     * Carrega schema de template JSON das 21 etapas
     */
    private async loadFromTemplate(stepId: string): Promise<QuizFunnelSchema> {
        try {
            // Carregar template JSON espec√≠fico
            const templatePath = `/templates/step-${stepId}-template.json`;
            const template = await TemplateJsonLoader.loadTemplate(templatePath);

            // Converter template JSON para QuizFunnelSchema
            const schema: QuizFunnelSchema = {
                id: template.metadata.id,
                name: template.metadata.name,
                description: template.metadata.description || '',
                version: template.templateVersion,
                category: (template.metadata.category as 'quiz' | 'lead-magnet' | 'sales-funnel' | 'assessment') || 'quiz',

                // Converter steps do template
                steps: template.blocks?.map((block, index) => ({
                    id: block.id || `step-${index + 1}`,
                    name: block.properties?.title || `Etapa ${index + 1}`,
                    description: block.properties?.description || 'Etapa criada a partir do template',
                    type: (this.mapBlockTypeToStepType(block.type) as 'intro' | 'lead-capture' | 'quiz-question' | 'strategic-question' | 'transition' | 'result' | 'offer' | 'thank-you' | 'custom'),
                    order: index + 1,
                    blocks: [{
                        id: block.id || `block-${index + 1}`,
                        order: index + 1,
                        type: block.type,
                        content: block.content || {},
                        properties: block.properties || {}
                    }] as Block[],
                    settings: {
                        showProgress: true,
                        progressStyle: 'bar' as const,
                        showBackButton: index > 0,
                        showNextButton: true,
                        allowSkip: false,
                        trackTimeOnStep: true,
                        trackInteractions: true,
                        customEvents: []
                    },
                    navigation: {
                        nextButton: {
                            text: 'Continuar',
                            visible: true,
                            conditions: []
                        },
                        backButton: {
                            text: 'Voltar',
                            visible: index > 0
                        },
                        skipButton: {
                            text: 'Pular',
                            visible: false,
                            conditions: []
                        }
                    },
                    validation: {
                        required: false,
                        rules: [],
                        errorMessages: {}
                    }
                })) || [],

                // Configura√ß√µes globais do template
                settings: {
                    seo: {
                        title: template.metadata.name,
                        description: template.metadata.description,
                        keywords: template.metadata.tags || [],
                    },
                    analytics: {
                        enabled: template.analytics?.enabled || false,
                        googleAnalytics: {
                            measurementId: template.analytics?.googleAnalyticsId || '',
                        },
                    },
                    branding: {
                        colors: {
                            primary: template.design?.primaryColor || '#B89B7A',
                            secondary: template.design?.secondaryColor || '#D4C2A8',
                            accent: template.design?.accentColor || '#4CAF50',
                            background: template.design?.backgroundColor || '#F9F5F1',
                        },
                        typography: {
                            fontFamily: {
                                primary: template.design?.primaryFont || 'Inter, system-ui, sans-serif',
                                secondary: template.design?.secondaryFont || 'Poppins, sans-serif',
                            },
                        },
                        logo: {
                            primary: template.design?.logoUrl || '',
                            favicon: template.design?.faviconUrl || '',
                        },
                        borderRadius: {
                            md: template.design?.borderRadius || '0.5rem',
                        },
                    },
                },

                // Configura√ß√µes de publica√ß√£o
                publication: {
                    status: 'draft',
                    baseUrl: '',
                    slug: template.metadata.id,
                    version: template.templateVersion,
                    accessControl: {
                        public: true,
                        requiresAuth: false,
                    },
                    cdn: {
                        enabled: false,
                    },
                },

                // Metadados do editor
                editorMeta: {
                    lastModified: new Date().toISOString(),
                    lastModifiedBy: 'system',
                    stats: {
                        totalBlocks: template.blocks?.length || 0,
                        estimatedCompletionTime: this.estimateCompletionTime(template.blocks || []),
                    },
                },
            };

            return schema;

        } catch (error) {
            console.error('‚ùå Erro ao carregar template:', error);
            throw error;
        }
    }

    /**
     * Carrega schema do localStorage
     */
    private async loadFromLocalStorage(schemaId: string): Promise<QuizFunnelSchema> {
        const key = `quiz-schema-${schemaId}`;
        const stored = localStorage.getItem(key);

        if (!stored) {
            throw new Error(`Schema n√£o encontrado no localStorage: ${schemaId}`);
        }

        return JSON.parse(stored);
    }

    /**
     * Carrega schema do Supabase
     */
    private async loadFromSupabase(schemaId: string): Promise<QuizFunnelSchema> {
        // TODO: Implementar carregamento do Supabase
        throw new Error('Carregamento do Supabase ainda n√£o implementado');
    }

    // ============================================================================
    // ATUALIZA√á√ïES DE DADOS
    // ============================================================================

    /**
     * Atualiza etapa espec√≠fica
     */
    updateStep(stepId: string, updates: Partial<FunnelStep>): void {
        if (!this.currentSchema) {
            console.warn('‚ö†Ô∏è Nenhum schema carregado para atualizar');
            return;
        }

        const stepIndex = this.currentSchema.steps.findIndex(step => step.id === stepId);
        if (stepIndex === -1) {
            console.warn(`‚ö†Ô∏è Etapa n√£o encontrada: ${stepId}`);
            return;
        }

        // Atualizar step
        this.currentSchema.steps[stepIndex] = {
            ...this.currentSchema.steps[stepIndex],
            ...updates,
        };

        // Atualizar metadados
        this.updateMetadata();

        // Notificar listeners
        this.notifyChange({
            type: 'step',
            stepId,
            changes: updates,
            timestamp: Date.now(),
        });

        // Agendar auto-save
        this.scheduleSave();
    }

    /**
     * Atualiza configura√ß√µes globais
     */
    updateGlobalSettings(updates: Partial<QuizFunnelSchema['settings']>): void {
        if (!this.currentSchema) {
            console.warn('‚ö†Ô∏è Nenhum schema carregado para atualizar');
            return;
        }

        this.currentSchema.settings = {
            ...this.currentSchema.settings,
            ...updates,
        };

        this.updateMetadata();

        this.notifyChange({
            type: 'global',
            changes: updates,
            timestamp: Date.now(),
        });

        this.scheduleSave();
    }

    /**
     * Atualiza configura√ß√µes de publica√ß√£o
     */
    updatePublicationSettings(updates: Partial<QuizFunnelSchema['publication']>): void {
        if (!this.currentSchema) {
            console.warn('‚ö†Ô∏è Nenhum schema carregado para atualizar');
            return;
        }

        this.currentSchema.publication = {
            ...this.currentSchema.publication,
            ...updates,
        };

        this.updateMetadata();

        this.notifyChange({
            type: 'publish',
            changes: updates,
            timestamp: Date.now(),
        });

        this.scheduleSave();
    }

    // ============================================================================
    // PERSIST√äNCIA
    // ============================================================================

    /**
     * Salva schema atual
     */
    async saveSchema(location?: 'localStorage' | 'supabase' | 'file'): Promise<PersistenceResult[]> {
        if (!this.currentSchema) {
            throw new Error('Nenhum schema para salvar');
        }

        const results: PersistenceResult[] = [];

        // Determinar locais de salvamento
        const locations = location ? [location] : ['localStorage', 'supabase'];

        for (const loc of locations) {
            try {
                let result: PersistenceResult;

                switch (loc) {
                    case 'localStorage':
                        result = await this.saveToLocalStorage();
                        break;
                    case 'supabase':
                        result = await this.saveToSupabase();
                        break;
                    case 'file':
                        result = await this.saveToFile();
                        break;
                    default:
                        continue;
                }

                results.push(result);

            } catch (error) {
                results.push({
                    success: false,
                    location: loc as any,
                    timestamp: Date.now(),
                    error: (error as Error).message,
                });
            }
        }

        if (results.some(r => r.success)) {
            this.isDirty = false;
        }

        return results;
    }

    private async saveToLocalStorage(): Promise<PersistenceResult> {
        const key = `quiz-schema-${this.currentSchema!.id}`;
        localStorage.setItem(key, JSON.stringify(this.currentSchema));

        return {
            success: true,
            location: 'localStorage',
            timestamp: Date.now(),
        };
    }

    private async saveToSupabase(): Promise<PersistenceResult> {
        // TODO: Implementar salvamento no Supabase
        throw new Error('Salvamento no Supabase ainda n√£o implementado');
    }

    private async saveToFile(): Promise<PersistenceResult> {
        const blob = new Blob([JSON.stringify(this.currentSchema, null, 2)], {
            type: 'application/json',
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${this.currentSchema!.id}.json`;
        a.click();

        URL.revokeObjectURL(url);

        return {
            success: true,
            location: 'file',
            timestamp: Date.now(),
        };
    }

    // ============================================================================
    // HELPERS
    // ============================================================================

    private mapBlockTypeToStepType(blockType: string): string {
        const mapping: Record<string, string> = {
            'intro-block': 'intro',
            'question-block': 'quiz-question',
            'options-grid': 'quiz-question',
            'lead-form': 'lead-capture',
            'result-block': 'result',
            'offer-block': 'offer',
        };

        return mapping[blockType] || 'custom';
    }

    private estimateCompletionTime(blocks: any[]): number {
        // Estima 30 segundos por bloco em m√©dia
        return Math.ceil(blocks.length * 0.5);
    }

    private validateSchema(schema: QuizFunnelSchema): void {
        if (!schema.id || !schema.name) {
            throw new Error('Schema deve ter id e name');
        }

        if (!schema.steps || schema.steps.length === 0) {
            throw new Error('Schema deve ter pelo menos uma etapa');
        }
    }

    private updateMetadata(): void {
        if (this.currentSchema) {
            this.currentSchema.editorMeta = {
                ...this.currentSchema.editorMeta,
                lastModified: new Date().toISOString(),
                lastModifiedBy: 'user',
            };
            this.isDirty = true;
        }
    }

    private notifyChange(event: SchemaChangeEvent): void {
        this.changeListeners.forEach(listener => {
            try {
                listener(event);
            } catch (error) {
                console.error('‚ùå Erro ao notificar listener:', error);
            }
        });
    }

    private scheduleSave(): void {
        if (!this.config.autoSave) return;

        if (this.autoSaveTimer) {
            clearTimeout(this.autoSaveTimer);
        }

        this.autoSaveTimer = setTimeout(() => {
            if (this.isDirty) {
                this.saveSchema().catch(console.error);
            }
        }, this.config.autoSaveInterval);
    }

    // ============================================================================
    // PUBLIC API
    // ============================================================================

    getCurrentSchema(): QuizFunnelSchema | null {
        return this.currentSchema;
    }

    isDirtySchema(): boolean {
        return this.isDirty;
    }

    addChangeListener(listener: (event: SchemaChangeEvent) => void): () => void {
        this.changeListeners.add(listener);
        return () => this.changeListeners.delete(listener);
    }

    dispose(): void {
        if (this.autoSaveTimer) {
            clearTimeout(this.autoSaveTimer);
        }
        this.changeListeners.clear();
    }
}

export default EditorDataService;