<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóÑÔ∏è IndexedDB vs LocalStorage - Teste de Performance</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button.warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .results {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
        }

        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .performance-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .bar {
            height: 10px;
            border-radius: 5px;
            margin: 5px 0;
            transition: width 0.3s ease;
        }

        .bar.indexeddb {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .bar.localstorage {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        pre {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
        }

        .log-success {
            background: rgba(76, 175, 80, 0.2);
        }

        .log-warning {
            background: rgba(255, 152, 0, 0.2);
        }

        .log-error {
            background: rgba(244, 67, 54, 0.2);
        }

        .log-info {
            background: rgba(33, 150, 243, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è IndexedDB vs LocalStorage</h1>
            <p>Teste de Performance para Sistema de Funis</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>üîç Detec√ß√£o de Capacidades</h3>
                <div id="capabilities">Carregando...</div>
            </div>
            <div class="stat-card">
                <h3>üìä Estat√≠sticas Atuais</h3>
                <div id="currentStats">Carregando...</div>
            </div>
        </div>

        <div class="test-controls">
            <button onclick="createTestFunnels(10)">üìù Criar 10 Funis Teste</button>
            <button onclick="createTestFunnels(100)" class="warning">üìù Criar 100 Funis Teste</button>
            <button onclick="performanceTest()">‚ö° Teste de Performance</button>
            <button onclick="migrationTest()">üîÑ Teste de Migra√ß√£o</button>
            <button onclick="clearAll()" class="danger">üóëÔ∏è Limpar Tudo</button>
        </div>

        <div class="results">
            <h3>üìà Resultados dos Testes</h3>
            <div id="results"></div>

            <h3>üîÑ Performance Comparison</h3>
            <div class="performance-comparison">
                <div class="performance-bar">
                    <h4>IndexedDB</h4>
                    <div class="bar indexeddb" id="indexeddb-bar" style="width: 0%"></div>
                    <span id="indexeddb-time">-</span>
                </div>
                <div class="performance-bar">
                    <h4>LocalStorage</h4>
                    <div class="bar localstorage" id="localstorage-bar" style="width: 0%"></div>
                    <span id="localstorage-time">-</span>
                </div>
            </div>

            <h3>üìã Log de Atividades</h3>
            <div id="log" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // SIMULA√á√ÉO DO SISTEMA H√çBRIDO
        // ============================================================================

        class TestStorage {
            constructor() {
                this.indexedDBSupported = this.checkIndexedDBSupport();
                this.localStorageSupported = this.checkLocalStorageSupport();
                this.init();
            }

            checkIndexedDBSupport() {
                return typeof indexedDB !== 'undefined';
            }

            checkLocalStorageSupport() {
                try {
                    localStorage.setItem('__test__', 'test');
                    localStorage.removeItem('__test__');
                    return true;
                } catch (e) {
                    return false;
                }
            }

            async init() {
                if (this.indexedDBSupported) {
                    this.db = await this.initIndexedDB();
                }
                this.updateCapabilities();
                this.updateStats();
            }

            initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('TestFunnelDB', 1);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('funnels')) {
                            const store = db.createObjectStore('funnels', { keyPath: 'id' });
                            store.createIndex('userId', 'userId', { unique: false });
                            store.createIndex('category', 'category', { unique: false });
                        }
                    };
                });
            }

            // IndexedDB Operations
            async saveToIndexedDB(funnel) {
                if (!this.db) throw new Error('IndexedDB n√£o inicializado');

                const transaction = this.db.transaction(['funnels'], 'readwrite');
                const store = transaction.objectStore('funnels');

                return new Promise((resolve, reject) => {
                    const request = store.put(funnel);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async loadFromIndexedDB(id) {
                if (!this.db) throw new Error('IndexedDB n√£o inicializado');

                const transaction = this.db.transaction(['funnels'], 'readonly');
                const store = transaction.objectStore('funnels');

                return new Promise((resolve, reject) => {
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async listFromIndexedDB() {
                if (!this.db) throw new Error('IndexedDB n√£o inicializado');

                const transaction = this.db.transaction(['funnels'], 'readonly');
                const store = transaction.objectStore('funnels');

                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // LocalStorage Operations
            saveToLocalStorage(funnel) {
                localStorage.setItem(`test-funnel-${funnel.id}`, JSON.stringify(funnel));
            }

            loadFromLocalStorage(id) {
                const data = localStorage.getItem(`test-funnel-${id}`);
                return data ? JSON.parse(data) : null;
            }

            listFromLocalStorage() {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('test-funnel-'));
                return keys.map(key => JSON.parse(localStorage.getItem(key)));
            }

            // Utility methods
            generateTestFunnel() {
                const id = `funnel_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                return {
                    id,
                    name: `Funil Teste ${id}`,
                    description: `Descri√ß√£o do funil de teste ${id}`,
                    category: ['quiz', 'lead-magnet', 'vendas'][Math.floor(Math.random() * 3)],
                    userId: 'test-user',
                    context: 'MY_FUNNELS',
                    settings: {
                        autoAdvance: Math.random() > 0.5,
                        showProgress: Math.random() > 0.3,
                        theme: ['default', 'modern', 'classic'][Math.floor(Math.random() * 3)]
                    },
                    pages: Array(21).fill(null).map((_, i) => ({
                        id: `page-${i + 1}`,
                        name: `Etapa ${i + 1}`,
                        blocks: Array(Math.floor(Math.random() * 5) + 1).fill(null).map((_, j) => ({
                            id: `block-${i}-${j}`,
                            type: ['header', 'text', 'button', 'image'][Math.floor(Math.random() * 4)],
                            properties: {
                                text: `Conte√∫do do bloco ${j + 1}`,
                                style: {
                                    fontSize: Math.floor(Math.random() * 24) + 12,
                                    color: `#${Math.floor(Math.random() * 16777215).toString(16)}`
                                }
                            }
                        }))
                    })),
                    isPublished: Math.random() > 0.5,
                    version: 1,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
            }

            updateCapabilities() {
                const capabilities = {
                    indexedDB: this.indexedDBSupported,
                    localStorage: this.localStorageSupported,
                    recommendation: this.indexedDBSupported ? 'IndexedDB' :
                        this.localStorageSupported ? 'LocalStorage' : 'Memory Only'
                };

                document.getElementById('capabilities').innerHTML = `
                    <div>‚úÖ IndexedDB: ${capabilities.indexedDB ? 'Suportado' : 'N√£o suportado'}</div>
                    <div>‚úÖ LocalStorage: ${capabilities.localStorage ? 'Suportado' : 'N√£o suportado'}</div>
                    <div><strong>Recomenda√ß√£o: ${capabilities.recommendation}</strong></div>
                `;
            }

            async updateStats() {
                let indexedDBCount = 0;
                let localStorageCount = 0;
                let localStorageSize = 0;

                if (this.indexedDBSupported && this.db) {
                    try {
                        const items = await this.listFromIndexedDB();
                        indexedDBCount = items.length;
                    } catch (e) {
                        console.warn('Erro ao contar IndexedDB:', e);
                    }
                }

                if (this.localStorageSupported) {
                    const keys = Object.keys(localStorage).filter(k => k.startsWith('test-funnel-'));
                    localStorageCount = keys.length;
                    localStorageSize = keys.reduce((size, key) => {
                        const value = localStorage.getItem(key) || '';
                        return size + key.length + value.length;
                    }, 0);
                }

                document.getElementById('currentStats').innerHTML = `
                    <div>üìä IndexedDB: ${indexedDBCount} funis</div>
                    <div>üíæ LocalStorage: ${localStorageCount} funis</div>
                    <div>üìè Tamanho LS: ${(localStorageSize / 1024).toFixed(2)} KB</div>
                `;
            }
        }

        // ============================================================================
        // FUN√á√ïES DE TESTE
        // ============================================================================

        const testStorage = new TestStorage();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function createTestFunnels(count) {
            log(`üöÄ Criando ${count} funis de teste...`, 'info');

            const startTime = performance.now();
            let indexedDBTime = 0;
            let localStorageTime = 0;

            const funnels = Array(count).fill(null).map(() => testStorage.generateTestFunnel());

            // Teste IndexedDB
            if (testStorage.indexedDBSupported) {
                const idbStart = performance.now();
                for (const funnel of funnels) {
                    await testStorage.saveToIndexedDB(funnel);
                }
                indexedDBTime = performance.now() - idbStart;
                log(`‚úÖ IndexedDB: ${count} funis salvos em ${indexedDBTime.toFixed(2)}ms`, 'success');
            }

            // Teste LocalStorage
            if (testStorage.localStorageSupported) {
                const lsStart = performance.now();
                for (const funnel of funnels) {
                    testStorage.saveToLocalStorage(funnel);
                }
                localStorageTime = performance.now() - lsStart;
                log(`‚úÖ LocalStorage: ${count} funis salvos em ${localStorageTime.toFixed(2)}ms`, 'success');
            }

            const totalTime = performance.now() - startTime;
            log(`‚úÖ Total: ${count} funis criados em ${totalTime.toFixed(2)}ms`, 'success');

            updatePerformanceBars(indexedDBTime, localStorageTime);
            testStorage.updateStats();
        }

        async function performanceTest() {
            log('‚ö° Iniciando teste de performance...', 'info');

            const testSizes = [10, 50, 100];
            const results = document.getElementById('results');
            results.innerHTML = '<h4>Resultados do Teste de Performance</h4>';

            for (const size of testSizes) {
                log(`üß™ Testando com ${size} opera√ß√µes...`, 'info');

                // Criar funis de teste
                const funnels = Array(size).fill(null).map(() => testStorage.generateTestFunnel());

                // Teste de escrita
                let indexedDBWrite = 0;
                let localStorageWrite = 0;

                if (testStorage.indexedDBSupported) {
                    const start = performance.now();
                    for (const funnel of funnels) {
                        await testStorage.saveToIndexedDB(funnel);
                    }
                    indexedDBWrite = performance.now() - start;
                }

                if (testStorage.localStorageSupported) {
                    const start = performance.now();
                    for (const funnel of funnels) {
                        testStorage.saveToLocalStorage(funnel);
                    }
                    localStorageWrite = performance.now() - start;
                }

                // Teste de leitura
                let indexedDBRead = 0;
                let localStorageRead = 0;

                if (testStorage.indexedDBSupported) {
                    const start = performance.now();
                    await testStorage.listFromIndexedDB();
                    indexedDBRead = performance.now() - start;
                }

                if (testStorage.localStorageSupported) {
                    const start = performance.now();
                    testStorage.listFromLocalStorage();
                    localStorageRead = performance.now() - start;
                }

                // Adicionar resultados
                const speedup = localStorageWrite > 0 ? (localStorageWrite / indexedDBWrite).toFixed(2) : 'N/A';
                results.innerHTML += `
                    <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <strong>${size} opera√ß√µes:</strong><br>
                        üìù Escrita - IndexedDB: ${indexedDBWrite.toFixed(2)}ms | LocalStorage: ${localStorageWrite.toFixed(2)}ms<br>
                        üìñ Leitura - IndexedDB: ${indexedDBRead.toFixed(2)}ms | LocalStorage: ${localStorageRead.toFixed(2)}ms<br>
                        ‚ö° Speedup: ${speedup}x
                    </div>
                `;

                log(`üìä ${size} ops - IDB: ${indexedDBWrite.toFixed(2)}ms, LS: ${localStorageWrite.toFixed(2)}ms`, 'success');
            }

            testStorage.updateStats();
        }

        async function migrationTest() {
            log('üîÑ Testando migra√ß√£o LocalStorage ‚Üí IndexedDB...', 'info');

            // Criar dados no localStorage
            const testData = Array(20).fill(null).map(() => testStorage.generateTestFunnel());
            testData.forEach(funnel => testStorage.saveToLocalStorage(funnel));
            log(`‚úÖ ${testData.length} funis criados no LocalStorage`, 'success');

            // Migrar para IndexedDB
            if (testStorage.indexedDBSupported) {
                const startTime = performance.now();

                for (const funnel of testData) {
                    await testStorage.saveToIndexedDB(funnel);
                }

                const migrationTime = performance.now() - startTime;
                log(`‚úÖ Migra√ß√£o conclu√≠da em ${migrationTime.toFixed(2)}ms`, 'success');

                // Verificar integridade
                const indexedDBData = await testStorage.listFromIndexedDB();
                const localStorageData = testStorage.listFromLocalStorage();

                log(`üîç Verifica√ß√£o: IDB=${indexedDBData.length}, LS=${localStorageData.length}`, 'info');

                if (indexedDBData.length === localStorageData.length) {
                    log('‚úÖ Migra√ß√£o verificada: dados √≠ntegros', 'success');
                } else {
                    log('‚ùå Migra√ß√£o falhou: dados inconsistentes', 'error');
                }
            } else {
                log('‚ùå IndexedDB n√£o suportado, migra√ß√£o n√£o poss√≠vel', 'error');
            }

            testStorage.updateStats();
        }

        async function clearAll() {
            log('üóëÔ∏è Limpando todos os dados...', 'warning');

            // Limpar IndexedDB
            if (testStorage.indexedDBSupported && testStorage.db) {
                const transaction = testStorage.db.transaction(['funnels'], 'readwrite');
                const store = transaction.objectStore('funnels');
                await new Promise((resolve) => {
                    const request = store.clear();
                    request.onsuccess = resolve;
                });
                log('‚úÖ IndexedDB limpo', 'success');
            }

            // Limpar LocalStorage
            const keys = Object.keys(localStorage).filter(k => k.startsWith('test-funnel-'));
            keys.forEach(key => localStorage.removeItem(key));
            log(`‚úÖ ${keys.length} itens removidos do LocalStorage`, 'success');

            // Limpar resultados
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            updatePerformanceBars(0, 0);
            testStorage.updateStats();
        }

        function updatePerformanceBars(indexedDBTime, localStorageTime) {
            const maxTime = Math.max(indexedDBTime, localStorageTime);

            if (maxTime > 0) {
                const indexedDBPercent = (indexedDBTime / maxTime) * 100;
                const localStoragePercent = (localStorageTime / maxTime) * 100;

                document.getElementById('indexeddb-bar').style.width = `${indexedDBPercent}%`;
                document.getElementById('localstorage-bar').style.width = `${localStoragePercent}%`;
                document.getElementById('indexeddb-time').textContent = `${indexedDBTime.toFixed(2)}ms`;
                document.getElementById('localstorage-time').textContent = `${localStorageTime.toFixed(2)}ms`;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Sistema de testes inicializado', 'success');
            log(`üì± Navegador: ${navigator.userAgent}`, 'info');
        });
    </script>
</body>

</html>