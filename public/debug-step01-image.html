<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Step-01 Image</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }

        h2 {
            color: #569cd6;
            margin-top: 30px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #0e4f1f;
            border-left: 4px solid #4ec9b0;
        }

        .error {
            background: #5a1d1d;
            border-left: 4px solid #f48771;
        }

        .warning {
            background: #5b5a30;
            border-left: 4px solid #dcdcaa;
        }

        .code {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #1177bb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #3c3c3c;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin: 2px;
        }

        .badge-success {
            background: #0e4f1f;
            color: #4ec9b0;
        }

        .badge-error {
            background: #5a1d1d;
            color: #f48771;
        }

        .badge-info {
            background: #1a2938;
            color: #569cd6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Debug Step-01 Image - DOM Inspection</h1>

        <div class="grid">
            <div class="card">
                <h3>üìä Status</h3>
                <div id="status">Aguardando teste...</div>
            </div>
            <div class="card">
                <h3>üéÆ Controles</h3>
                <button onclick="runDiagnostic()">üîÑ Executar Diagn√≥stico</button>
                <button onclick="openEditor()">üìù Abrir Editor</button>
                <button onclick="clearResults()">üóëÔ∏è Limpar</button>
            </div>
        </div>

        <h2>1Ô∏è‚É£ Verifica√ß√£o do JSON</h2>
        <div id="json-check" class="code">Verificando...</div>

        <h2>2Ô∏è‚É£ Verifica√ß√£o do DOM</h2>
        <div id="dom-check" class="code">Aguardando...</div>

        <h2>3Ô∏è‚É£ Detalhes do Elemento</h2>
        <div id="element-details" class="code">Aguardando...</div>

        <h2>4Ô∏è‚É£ Todos os Blocos Renderizados</h2>
        <div id="all-blocks" class="code">Aguardando...</div>

        <h2>5Ô∏è‚É£ Console Logs</h2>
        <div id="console-logs" class="code">Aguardando...</div>
    </div>

    <script>
        let logs = [];

        // Interceptar console.log
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function (...args) {
            logs.push({ type: 'log', message: args.join(' '), time: new Date().toISOString() });
            originalLog.apply(console, args);
        };

        console.warn = function (...args) {
            logs.push({ type: 'warn', message: args.join(' '), time: new Date().toISOString() });
            originalWarn.apply(console, args);
        };

        console.error = function (...args) {
            logs.push({ type: 'error', message: args.join(' '), time: new Date().toISOString() });
            originalError.apply(console, args);
        };

        async function runDiagnostic() {
            document.getElementById('status').innerHTML = '<span class="badge badge-info">üîÑ Executando...</span>';
            logs = []; // Reset logs

            // 1. Verificar JSON
            await checkJSON();

            // 2. Verificar DOM (aguardar um pouco para o editor carregar)
            setTimeout(() => {
                checkDOM();
                checkAllBlocks();
                displayConsoleLogs();
                document.getElementById('status').innerHTML = '<span class="badge badge-success">‚úÖ Diagn√≥stico Completo</span>';
            }, 2000);
        }

        async function checkJSON() {
            const div = document.getElementById('json-check');
            try {
                const response = await fetch('/templates/blocks/step-01.json');
                if (!response.ok) {
                    div.innerHTML = `<div class="error">‚ùå Erro ao carregar JSON: ${response.status}</div>`;
                    return;
                }

                const data = await response.json();

                let html = '<div class="success">‚úÖ JSON carregado com sucesso!</div>';
                html += `<br><strong>ID:</strong> ${data.id}`;
                html += `<br><strong>Title:</strong> ${data.title}`;
                html += `<br><strong>Total de Blocos:</strong> ${data.blocks?.length || 0}`;
                html += '<br><br><strong>üì¶ Blocos:</strong><br>';

                const imageBlock = data.blocks?.find(b => b.type === 'intro-image');

                data.blocks?.forEach((block, idx) => {
                    const isImageBlock = block.type === 'intro-image';
                    const badge = isImageBlock ? 'badge-success' : 'badge-info';
                    html += `<span class="badge ${badge}">${idx + 1}. ${block.type}</span> `;
                });

                if (imageBlock) {
                    html += '<br><br><div class="success">üñºÔ∏è Bloco intro-image ENCONTRADO no JSON!</div>';
                    html += `<br><strong>Image URL:</strong> ${imageBlock.content?.imageUrl || imageBlock.content?.src || 'N/A'}`;
                    html += `<br><strong>Alt:</strong> ${imageBlock.content?.alt || 'N/A'}`;
                    html += `<br><strong>Width:</strong> ${imageBlock.content?.width || 'N/A'}`;
                    html += `<br><strong>Height:</strong> ${imageBlock.content?.height || 'N/A'}`;
                } else {
                    html += '<br><br><div class="error">‚ùå Bloco intro-image N√ÉO encontrado no JSON!</div>';
                }

                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        function checkDOM() {
            const div = document.getElementById('dom-check');

            // Abrir o editor em iframe
            const editorWindow = window.open('/editor?template=quiz21StepsComplete', 'editorWindow');

            if (!editorWindow) {
                div.innerHTML = '<div class="error">‚ùå Pop-up bloqueado! Permitir pop-ups e tentar novamente.</div>';
                return;
            }

            div.innerHTML = '<div class="warning">‚è≥ Editor aberto em nova janela. Aguardando carregamento...</div>';

            // Aguardar o editor carregar e verificar
            setTimeout(() => {
                try {
                    const editorDoc = editorWindow.document;

                    // Verificar por diferentes seletores
                    const imgByAlt = editorDoc.querySelector('[alt="Descubra seu estilo predominante"]');
                    const imgBySrc = editorDoc.querySelector('img[src*="Gemini_Generated_Image"]');
                    const allImages = editorDoc.querySelectorAll('img');
                    const introBlocks = editorDoc.querySelectorAll('[data-block-type^="intro"]');

                    let html = '';

                    if (imgByAlt) {
                        html += '<div class="success">‚úÖ Imagem ENCONTRADA no DOM (por alt)!</div>';
                        html += `<br><strong>Tag:</strong> ${imgByAlt.tagName}`;
                        html += `<br><strong>URL:</strong> ${imgByAlt.src}`;
                        html += `<br><strong>Alt:</strong> ${imgByAlt.alt}`;
                        html += `<br><strong>Width:</strong> ${imgByAlt.width}px`;
                        html += `<br><strong>Height:</strong> ${imgByAlt.height}px`;
                        html += `<br><strong>Vis√≠vel:</strong> ${imgByAlt.offsetWidth > 0 && imgByAlt.offsetHeight > 0 ? '‚úÖ Sim' : '‚ùå N√£o'}`;
                    } else if (imgBySrc) {
                        html += '<div class="warning">‚ö†Ô∏è Imagem encontrada por src, mas n√£o por alt!</div>';
                        html += `<br><strong>URL:</strong> ${imgBySrc.src}`;
                    } else {
                        html += '<div class="error">‚ùå Imagem N√ÉO encontrada no DOM!</div>';
                        html += `<br><strong>Total de imagens na p√°gina:</strong> ${allImages.length}`;
                        html += `<br><strong>Blocos intro- encontrados:</strong> ${introBlocks.length}`;
                    }

                    div.innerHTML = html;

                    // Mostrar detalhes do elemento
                    if (imgByAlt) {
                        displayElementDetails(imgByAlt);
                    }
                } catch (error) {
                    div.innerHTML = `<div class="error">‚ùå Erro ao acessar DOM: ${error.message}</div>`;
                }
            }, 3000);
        }

        function displayElementDetails(element) {
            const div = document.getElementById('element-details');

            const styles = window.getComputedStyle(element);

            let html = '<div class="success">üìã Propriedades do Elemento:</div><br>';
            html += `<strong>Display:</strong> ${styles.display}<br>`;
            html += `<strong>Visibility:</strong> ${styles.visibility}<br>`;
            html += `<strong>Opacity:</strong> ${styles.opacity}<br>`;
            html += `<strong>Position:</strong> ${styles.position}<br>`;
            html += `<strong>Max-Width:</strong> ${styles.maxWidth}<br>`;
            html += `<strong>Object-Fit:</strong> ${styles.objectFit}<br>`;
            html += `<strong>Border-Radius:</strong> ${styles.borderRadius}<br>`;
            html += `<br><strong>Classes:</strong> ${element.className || '(nenhuma)'}<br>`;
            html += `<strong>Parent:</strong> ${element.parentElement?.tagName || 'N/A'}<br>`;

            div.innerHTML = html;
        }

        function checkAllBlocks() {
            const div = document.getElementById('all-blocks');

            const editorWindow = window.open('', 'editorWindow');

            if (!editorWindow) {
                div.innerHTML = '<div class="error">‚ùå Janela do editor n√£o encontrada</div>';
                return;
            }

            try {
                const editorDoc = editorWindow.document;
                const allBlocks = editorDoc.querySelectorAll('[data-block-type], [data-testid^="block"]');

                let html = `<strong>Total de blocos renderizados:</strong> ${allBlocks.length}<br><br>`;

                allBlocks.forEach((block, idx) => {
                    const type = block.getAttribute('data-block-type') || block.getAttribute('data-testid') || 'unknown';
                    const isVisible = block.offsetWidth > 0 && block.offsetHeight > 0;
                    const badge = isVisible ? 'badge-success' : 'badge-error';
                    html += `<span class="badge ${badge}">${idx + 1}. ${type} ${isVisible ? '‚úÖ' : '‚ùå'}</span> `;
                });

                div.innerHTML = html;
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        function displayConsoleLogs() {
            const div = document.getElementById('console-logs');

            if (logs.length === 0) {
                div.innerHTML = '<div class="warning">‚ö†Ô∏è Nenhum log capturado</div>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                const cssClass = log.type === 'error' ? 'error' : log.type === 'warn' ? 'warning' : 'success';
                html += `<div class="${cssClass}">[${log.type.toUpperCase()}] ${log.message}</div>`;
            });

            div.innerHTML = html;
        }

        function openEditor() {
            window.open('/editor?template=quiz21StepsComplete', 'editorWindow');
        }

        function clearResults() {
            document.getElementById('json-check').innerHTML = 'Aguardando...';
            document.getElementById('dom-check').innerHTML = 'Aguardando...';
            document.getElementById('element-details').innerHTML = 'Aguardando...';
            document.getElementById('all-blocks').innerHTML = 'Aguardando...';
            document.getElementById('console-logs').innerHTML = 'Aguardando...';
            document.getElementById('status').innerHTML = 'Aguardando teste...';
            logs = [];
        }

        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 1000);
        });
    </script>
</body>

</html>