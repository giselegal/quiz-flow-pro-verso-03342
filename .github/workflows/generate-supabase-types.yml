name: Generate Supabase Types

on:
  workflow_dispatch:
  push:
    paths:
      - 'supabase/**'
      - 'migrations/**'
      - '.github/workflows/generate-supabase-types.yml'

jobs:
  gen-types:
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${SUPABASE_ACCESS_TOKEN}" ] || [ -z "${SUPABASE_PROJECT_ID}" ]; then
            echo "Missing SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_ID secrets. Skipping generation." >&2
            exit 78
          fi

      - name: Generate types via Supabase CLI (Docker)
        run: |
          mkdir -p src/types
          docker run --rm \
            -e SUPABASE_ACCESS_TOKEN="${SUPABASE_ACCESS_TOKEN}" \
            -v "$PWD":/workspace -w /workspace \
            supabase/cli:latest \
            gen types typescript --project-id "${SUPABASE_PROJECT_ID}" > src/types/supabase.ts

      - name: Upload types artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-types
          path: src/types/supabase.ts
