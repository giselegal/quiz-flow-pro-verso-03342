<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Corre√ß√£o - Sistema de Funis</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 20px;
            background: #FAF9F7;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .test-result {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }

        .success {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }

        .error {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }

        .warning {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }

        .info {
            border-left: 4px solid #007bff;
            background: #d1ecf1;
        }

        .test-button {
            background: #B89B7A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s;
        }

        .test-button:hover {
            background: #A0895B;
            transform: translateY(-1px);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .critical {
            background: #dc3545 !important;
            color: white;
            font-weight: bold;
        }

        .critical:hover {
            background: #c82333 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Teste de Corre√ß√£o - Sistema de Funis</h1>
        <p><strong>Objetivo:</strong> Verificar se as corre√ß√µes aplicadas resolveram os problemas de fragmenta√ß√£o do
            sistema de armazenamento.</p>

        <div class="test-section">
            <h2>üîç Diagn√≥stico de Armazenamento</h2>
            <button class="test-button" onclick="diagnosticarArmazenamento()">
                üîç Diagnosticar LocalStorage
            </button>
            <button class="test-button" onclick="testarConsistenciaIDs()">
                üÜî Testar Consist√™ncia de IDs
            </button>
            <button class="test-button" onclick="verificarSistemasAtivos()">
                üìä Verificar Sistemas Ativos
            </button>
        </div>

        <div class="test-section">
            <h2>üöÄ Teste de Navega√ß√£o</h2>
            <button class="test-button critical" onclick="testarFluxoCompleto()">
                ‚ö° TESTE CR√çTICO: Fluxo Admin ‚Üí Editor
            </button>
            <button class="test-button" onclick="simularCriacaoFunil()">
                ‚ûï Simular Cria√ß√£o de Funil
            </button>
            <button class="test-button" onclick="verificarNavegacao()">
                üß≠ Verificar Navega√ß√£o
            </button>
        </div>

        <div class="test-section">
            <h2>üîß Testes de Corre√ß√£o</h2>
            <button class="test-button" onclick="verificarUnificacao()">
                üîó Verificar Unifica√ß√£o
            </button>
            <button class="test-button" onclick="testarMigracao()">
                üì¶ Testar Migra√ß√£o de Dados
            </button>
            <button class="test-button" onclick="limpezaDados()">
                üßπ Limpeza de Dados Duplicados
            </button>
        </div>

        <div id="results"></div>

        <div class="test-section" style="margin-top: 40px;">
            <h2>üîß Informa√ß√µes do Sistema</h2>
            <div id="systemInfo" class="test-result info">
                Carregando informa√ß√µes do sistema...
            </div>
        </div>
    </div>

    <script>
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            carregarInformacoesSistema();
            addResult('üöÄ Sistema de teste inicializado', 'success');
        });

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);

            // Scroll para o resultado
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function carregarInformacoesSistema() {
            const info = document.getElementById('systemInfo');
            const totalKeys = localStorage.length;
            const funnelKeys = [];
            const unifiedKeys = [];
            const legacyKeys = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    if (key.startsWith('unified_funnel:')) unifiedKeys.push(key);
                    else if (key.startsWith('funnel-')) legacyKeys.push(key);
                    else if (key.includes('funnel')) funnelKeys.push(key);
                }
            }

            info.innerHTML = `
                <strong>URL Base:</strong> ${window.location.origin}<br>
                <strong>P√°gina Atual:</strong> ${window.location.pathname}<br>
                <strong>Total de Chaves:</strong> ${totalKeys}<br>
                <strong>Chaves Unificadas:</strong> ${unifiedKeys.length}<br>
                <strong>Chaves Legacy:</strong> ${legacyKeys.length}<br>
                <strong>Outras Chaves de Funil:</strong> ${funnelKeys.length}<br>
                <strong>User Agent:</strong> ${navigator.userAgent.substring(0, 100)}...
            `;
        }

        function diagnosticarArmazenamento() {
            addResult('üîç Iniciando diagn√≥stico completo do localStorage...', 'info');

            const sistemas = {
                unified: { keys: [], prefix: 'unified_funnel:' },
                legacy: { keys: [], prefix: 'funnel-' },
                advanced: { keys: [], prefix: 'qqcv_' },
                ai: { keys: [], prefix: 'ai-generated-funnel-' },
                core: { keys: [], prefix: 'funnel-core-' },
                progress: { keys: [], prefix: 'funnel_progress_' },
                outros: { keys: [], prefix: '' }
            };

            // Classificar todas as chaves
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;

                let classificado = false;
                Object.entries(sistemas).forEach(([nome, sistema]) => {
                    if (sistema.prefix && key.startsWith(sistema.prefix)) {
                        sistema.keys.push(key);
                        classificado = true;
                    }
                });

                if (!classificado && key.includes('funnel')) {
                    sistemas.outros.keys.push(key);
                }
            }

            // Gerar relat√≥rio
            let problemasEncontrados = 0;
            Object.entries(sistemas).forEach(([nome, sistema]) => {
                if (sistema.keys.length > 0) {
                    addResult(`üìã Sistema "${nome}": ${sistema.keys.length} chaves encontradas`, 'info');

                    if (nome !== 'unified' && sistema.keys.length > 0) {
                        problemasEncontrados++;
                        addResult(`‚ö†Ô∏è FRAGMENTA√á√ÉO: Sistema "${nome}" ainda ativo!`, 'warning');
                    }
                } else {
                    addResult(`‚úÖ Sistema "${nome}": Nenhuma chave encontrada`, 'success');
                }
            });

            // Conclus√£o
            if (problemasEncontrados === 0) {
                addResult('üéâ SUCESSO: Sistema unificado funcionando corretamente!', 'success');
            } else {
                addResult(`üö® PROBLEMA: ${problemasEncontrados} sistemas fragmentados ainda ativos`, 'error');
            }
        }

        function testarConsistenciaIDs() {
            addResult('üÜî Testando consist√™ncia de gera√ß√£o de IDs...', 'info');

            // Simular gera√ß√£o de IDs
            const idsGerados = [];
            for (let i = 0; i < 5; i++) {
                const id = `test-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                idsGerados.push(id);

                // Pequeno delay para evitar IDs id√™nticos
                if (i < 4) {
                    const start = Date.now();
                    while (Date.now() - start < 10) { }
                }
            }

            addResult(`üìù IDs de teste gerados: ${idsGerados.length}`, 'info');

            // Verificar se h√° duplicatas
            const unicos = new Set(idsGerados);
            if (unicos.size === idsGerados.length) {
                addResult('‚úÖ SUCESSO: Todos os IDs s√£o √∫nicos', 'success');
            } else {
                addResult('‚ùå PROBLEMA: IDs duplicados detectados!', 'error');
            }

            // Verificar comprimento dos IDs
            const comprimentoMedio = idsGerados.reduce((acc, id) => acc + id.length, 0) / idsGerados.length;
            if (comprimentoMedio < 50) {
                addResult(`‚úÖ Comprimento m√©dio dos IDs: ${comprimentoMedio.toFixed(1)} caracteres`, 'success');
            } else {
                addResult(`‚ö†Ô∏è IDs muito longos: ${comprimentoMedio.toFixed(1)} caracteres em m√©dia`, 'warning');
            }
        }

        function verificarSistemasAtivos() {
            addResult('üìä Verificando sistemas ativos...', 'info');

            const testes = [
                {
                    nome: 'FunnelUnifiedService',
                    verificar: () => typeof window.funnelUnifiedService !== 'undefined',
                    esperado: true
                },
                {
                    nome: 'funnelLocalStore',
                    verificar: () => typeof window.funnelLocalStore !== 'undefined',
                    esperado: false // Deveria estar deprecado
                },
                {
                    nome: 'localStorage dispon√≠vel',
                    verificar: () => typeof localStorage !== 'undefined',
                    esperado: true
                },
                {
                    nome: 'IndexedDB dispon√≠vel',
                    verificar: () => typeof indexedDB !== 'undefined',
                    esperado: true
                }
            ];

            testes.forEach(teste => {
                const resultado = teste.verificar();
                const status = resultado === teste.esperado ? 'success' : 'warning';
                const icon = resultado === teste.esperado ? '‚úÖ' : '‚ö†Ô∏è';

                addResult(`${icon} ${teste.nome}: ${resultado ? 'Dispon√≠vel' : 'N√£o dispon√≠vel'}`, status);
            });
        }

        function testarFluxoCompleto() {
            addResult('‚ö° INICIANDO TESTE CR√çTICO: Fluxo completo Admin ‚Üí Editor', 'info');

            // Simular o fluxo exato do bug reportado
            const templateId = 'quiz-estilo-21-steps';
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substr(2, 8);
            const funnelId = `${templateId}-${timestamp}_${randomId}`;

            addResult(`üéØ Template ID: ${templateId}`, 'info');
            addResult(`üÜî Funnel ID gerado: ${funnelId}`, 'info');

            // Simular salvamento (como seria feito pela corre√ß√£o)
            const funnelData = {
                id: funnelId,
                name: `Teste - ${new Date().toLocaleTimeString()}`,
                status: 'draft',
                updatedAt: new Date().toISOString(),
                templateId: templateId,
                context: 'TEMPLATES'
            };

            // Testar salvamento unificado
            try {
                const unifiedKey = `unified_funnel:${funnelId}`;
                localStorage.setItem(unifiedKey, JSON.stringify(funnelData));
                addResult('üíæ SUCESSO: Funil salvo com chave unificada', 'success');
            } catch (error) {
                addResult(`‚ùå ERRO: Falha ao salvar: ${error.message}`, 'error');
                return;
            }

            // Testar recupera√ß√£o
            try {
                const unifiedKey = `unified_funnel:${funnelId}`;
                const recovered = localStorage.getItem(unifiedKey);
                if (recovered) {
                    const parsed = JSON.parse(recovered);
                    addResult('üîç SUCESSO: Funil recuperado com chave unificada', 'success');
                    addResult(`üìã Dados recuperados: ${parsed.name}`, 'info');
                } else {
                    addResult('‚ùå ERRO: Funil n√£o encontrado ap√≥s salvamento!', 'error');
                    return;
                }
            } catch (error) {
                addResult(`‚ùå ERRO: Falha na recupera√ß√£o: ${error.message}`, 'error');
                return;
            }

            // Simular navega√ß√£o
            const editorUrl = `/editor/${encodeURIComponent(funnelId)}?template=${templateId}`;
            addResult(`üîó URL do editor: ${editorUrl}`, 'info');

            // Teste final
            addResult('üéâ TESTE CR√çTICO PASSOU: Sistema unificado funcionando!', 'success');

            setTimeout(() => {
                if (confirm('Deseja navegar para o editor para teste manual?')) {
                    window.location.href = editorUrl;
                }
            }, 1000);
        }

        function simularCriacaoFunil() {
            addResult('‚ûï Simulando cria√ß√£o de funil...', 'info');

            const novoFunil = {
                id: `novo-funil-${Date.now()}`,
                name: `Funil de Teste - ${new Date().toLocaleString()}`,
                status: 'draft',
                updatedAt: new Date().toISOString()
            };

            // Salvar usando sistema unificado
            const chaveUnificada = `unified_funnel:${novoFunil.id}`;
            localStorage.setItem(chaveUnificada, JSON.stringify(novoFunil));

            addResult(`‚úÖ Funil criado: ${novoFunil.name}`, 'success');
            addResult(`üîë Chave unificada: ${chaveUnificada}`, 'info');

            // Verificar se foi salvo corretamente
            const verificacao = localStorage.getItem(chaveUnificada);
            if (verificacao) {
                addResult('‚úÖ VERIFICA√á√ÉO: Funil encontrado no storage', 'success');
            } else {
                addResult('‚ùå ERRO: Funil n√£o encontrado ap√≥s salvamento!', 'error');
            }
        }

        function verificarNavegacao() {
            addResult('üß≠ Verificando capacidades de navega√ß√£o...', 'info');

            const testes = [
                { nome: 'History API', teste: () => typeof history !== 'undefined' },
                { nome: 'window.location', teste: () => typeof window.location !== 'undefined' },
                { nome: 'URL Constructor', teste: () => typeof URL !== 'undefined' }
            ];

            testes.forEach(({ nome, teste }) => {
                const resultado = teste();
                addResult(`${resultado ? '‚úÖ' : '‚ùå'} ${nome}: ${resultado ? 'Dispon√≠vel' : 'N√£o dispon√≠vel'}`,
                    resultado ? 'success' : 'error');
            });

            // Testar URLs
            try {
                const testUrl = new URL('/editor/test-123', window.location.origin);
                addResult(`‚úÖ URL de teste criada: ${testUrl.href}`, 'success');
            } catch (error) {
                addResult(`‚ùå Erro ao criar URL: ${error.message}`, 'error');
            }
        }

        function verificarUnificacao() {
            addResult('üîó Verificando status da unifica√ß√£o...', 'info');

            const chaves = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('funnel')) {
                    chaves.push(key);
                }
            }

            const unificadas = chaves.filter(k => k.startsWith('unified_funnel:'));
            const legacy = chaves.filter(k => k.startsWith('funnel-'));
            const outras = chaves.filter(k => !k.startsWith('unified_funnel:') && !k.startsWith('funnel-'));

            addResult(`üìä Chaves unificadas: ${unificadas.length}`, unificadas.length > 0 ? 'success' : 'info');
            addResult(`üìä Chaves legacy: ${legacy.length}`, legacy.length === 0 ? 'success' : 'warning');
            addResult(`üìä Outras chaves: ${outras.length}`, 'info');

            if (legacy.length === 0) {
                addResult('üéâ UNIFICA√á√ÉO COMPLETA: Nenhuma chave legacy encontrada!', 'success');
            } else {
                addResult(`‚ö†Ô∏è UNIFICA√á√ÉO PARCIAL: ${legacy.length} chaves legacy ainda existem`, 'warning');
            }
        }

        function testarMigracao() {
            addResult('üì¶ Testando migra√ß√£o de dados legacy...', 'info');

            // Criar dados legacy de teste
            const funnelIdTeste = `teste-migracao-${Date.now()}`;
            const dadosLegacy = {
                id: funnelIdTeste,
                name: 'Funil Legacy de Teste',
                status: 'draft'
            };

            // Salvar no formato legacy
            const chaveLegacy = `funnel-${funnelIdTeste}`;
            localStorage.setItem(chaveLegacy, JSON.stringify(dadosLegacy));
            addResult(`üìù Dados legacy criados: ${chaveLegacy}`, 'info');

            // Simular migra√ß√£o
            try {
                const dadosParaMigrar = localStorage.getItem(chaveLegacy);
                if (dadosParaMigrar) {
                    const parsed = JSON.parse(dadosParaMigrar);

                    // Migrar para formato unificado
                    const chaveUnificada = `unified_funnel:${parsed.id}`;
                    const dadosUnificados = {
                        ...parsed,
                        context: 'MIGRATED',
                        migratedAt: new Date().toISOString()
                    };

                    localStorage.setItem(chaveUnificada, JSON.stringify(dadosUnificados));
                    addResult('‚úÖ MIGRA√á√ÉO: Dados migrados para formato unificado', 'success');

                    // Remover dados legacy
                    localStorage.removeItem(chaveLegacy);
                    addResult('üßπ LIMPEZA: Dados legacy removidos', 'success');

                } else {
                    addResult('‚ùå ERRO: Dados legacy n√£o encontrados', 'error');
                }
            } catch (error) {
                addResult(`‚ùå ERRO na migra√ß√£o: ${error.message}`, 'error');
            }
        }

        function limpezaDados() {
            addResult('üßπ Iniciando limpeza de dados duplicados...', 'info');

            const chavesParaLimpar = [];
            const chavesLegacy = [];
            const chavesOutras = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;

                if (key.startsWith('funnel-') && !key.startsWith('funnel-core-')) {
                    chavesLegacy.push(key);
                } else if (key.includes('funnel') && !key.startsWith('unified_funnel:')) {
                    chavesOutras.push(key);
                }
            }

            addResult(`üîç Encontradas ${chavesLegacy.length} chaves legacy`, 'info');
            addResult(`üîç Encontradas ${chavesOutras.length} outras chaves`, 'info');

            if (chavesLegacy.length === 0 && chavesOutras.length === 0) {
                addResult('‚úÖ LIMPEZA: Nenhum dado duplicado encontrado!', 'success');
                return;
            }

            const confirmar = confirm(`Deseja remover ${chavesLegacy.length + chavesOutras.length} chaves duplicadas/legacy?`);
            if (!confirmar) {
                addResult('‚è∏Ô∏è Limpeza cancelada pelo usu√°rio', 'warning');
                return;
            }

            let removidas = 0;
            [...chavesLegacy, ...chavesOutras].forEach(key => {
                try {
                    localStorage.removeItem(key);
                    removidas++;
                } catch (error) {
                    addResult(`‚ùå Erro ao remover ${key}: ${error.message}`, 'error');
                }
            });

            addResult(`üßπ LIMPEZA CONCLU√çDA: ${removidas} chaves removidas`, 'success');
            carregarInformacoesSistema(); // Atualizar info
        }
    </script>
</body>

</html>